{% extends 'appbuilder/baselayout.html' %}


{% block head_js %}
{{ super() }}
<script src= "http://ajax.googleapis.com/ajax/libs/angularjs/1.2.26/angular.min.js"></script>

<script type="text/javascript">
var can_show = {{ "true" if "can_show" | is_item_visible(modelview_name) else "false" }};
var can_add = {{ "true" if "can_add" | is_item_visible(modelview_name) else "false" }};
var can_edit = {{ "true" if "can_edit" | is_item_visible(modelview_name) else "false" }};
var can_delete = {{ "true" if "can_delete" | is_item_visible(modelview_name) else "false" }};
var base_url = "{{ url_for(modelview_name + ".read") }}";
var show_url = "{{ url_for(modelview_name + ".show", pk="") }}";
var add_url = "{{ url_for(modelview_name + ".add") }}";
var edit_url = "{{ url_for(modelview_name + ".edit", pk="") }}";
var delete_url = "{{ url_for(modelview_name + ".delete", pk="") }}";

</script>

<script type="text/javascript">

var app = angular.module('myApp', []);

app.config(['$interpolateProvider', function($interpolateProvider) {
  $interpolateProvider.startSymbol('{[');
  $interpolateProvider.endSymbol(']}');
}]);

app.controller("TableCtrl", function($scope, $http) {

  $scope.filter = "";
  $scope.order_column = "";
  $scope.order_direction = "";
  $scope.base_url = base_url;
  $scope.show_url = show_url;
  $scope.add_url = add_url;
  $scope.edit_url = edit_url;
  $scope.delete_url = delete_url;


  function ajaxGet() {
      var query_string = "";
      var get_params = {};
      if ($scope.filter != "" ) {
        get_params['_flt_0_name'] = $scope.filter;
      }
      if ($scope.order_column != "") {
        get_params['_oc_ContactModelView2'] = $scope.order_column;
        get_params['_od_ContactModelView2'] = $scope.order_direction;
      }
      console.log("GET", get_params);
      $http.get($scope.base_url, { params : get_params }).
        success(function(data, status, headers, config) {
          $scope.data = data;
        }).
        error(function(data, status, headers, config) {
          // log error
        });
   }
   $scope.$watch('filter', function (value) {
        ajaxGet();
    });

    $scope.orderClick = function(col) {
        if ($scope.order_column == col) {
            if ($scope.order_direction == 'asc') {
                $scope.order_direction = 'desc';
            }
            else {
                $scope.order_direction = 'asc';
            }
        }
        else {
            $scope.order_column = col;
            $scope.order_direction = 'asc';
        }
        ajaxGet();
    }

    $scope.getOrderType = function(col) {
        if ($scope.order_column == col) {
            if ($scope.order_direction == 'asc') {
                return 2;
            }
            else {
                return 1;
            }
        }
        return 0;
    }

    ajaxGet();
    console.log($scope);
});


</script>
{% endblock %}


{% block content %}
{{ super() }}

<div  ng-app="myApp" >
<div ng-controller="TableCtrl">

    <input class=" filter_val form-control" ng-model='filter' id="name" name="_flt_0_name" placeholder="Name" type="text" value="">

    <div class="table-responsive">
    <table class="table table-bordered table-hover">
        <thead id="thead">
        <tr>
        <th class="col-md-1 col-lg-1 col-sm-1" ></th>
        <th ng-repeat="col in data.list_columns">
            <a href="#" ng-click="orderClick(col)">{[data.label_columns[col];]}
                <i ng-if="getOrderType(col) == 2" class="animate-switch fa fa-chevron-up pull-right"></i>
                <i ng-if="getOrderType(col) == 1" class="animate-switch fa fa-chevron-down pull-right"></i>
                <i ng-if="getOrderType(col) == 0" class="animate-switch fa fa-arrows-v pull-right"></i>
            </a>
        </th></tr>
        </thead>
        <tbody id="tbody">
            <tr ng-repeat="row in data.result">
                <td><center>
                    <div class="btn-group btn-group-xs" style="display: flex;">
                        <a href="{[show_url + data.pks[$index]]}" class="btn btn-sm btn-primary" data-toggle="tooltip" rel="tooltip"
                        title="{{_('Show record')}}">
                        <i class="fa fa-search"></i>
                        </a>
                        <a href="{[edit_url + data.pks[$index]]}" class="btn btn-sm btn-primary" data-toggle="tooltip" rel="tooltip"
                        title="{{_('Show record')}}">
                        <i class="fa fa-edit"></i>
                        </a>
                        <a data-text="{{ _('You sure you want to delete this item?') }}" data-href="{[delete_url + data.pks[$index]]}" class="btn btn-sm btn-primary confirm" rel="tooltip"
                        title="{{_('Delete record')}}" data-toggle="modal" data-target="#modal-confirm" href="#">
                        <i class="fa fa-eraser"></i>
                        </a>
                    </div>
                </center></td>
                <td ng-repeat="col in data.list_columns">{[row[col] ]}</td>
            </tr>
        </tbody>
    </table>
    </div>
</div>
</div>


{% endblock %}
